name: Check formatting flow

on:
  workflow_call:
    secrets:
      github-token:
        description: "if provided an user GH's token, it will push update; requires `push` event"
        required: false
    inputs:
      python-version:
        description: "Python version to use"
        default: "3.9"
        required: false
        type: string
      use-cache:
        description: "enable using GH caching for performance boost"
        type: boolean
        required: false
        default: true
      push-fixes:
        description: "if provided an user GH's token, it will push update; requires `push` event"
        type: boolean
        required: false
        default: false

defaults:
  run:
    shell: bash

jobs:
  pre-commit:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.github-token || github.token }}

      - name: Set up uv and Python üêç
        uses: astral-sh/setup-uv@v7
        with:
          activate-environment: true
          python-version: ${{ inputs.python-version }}
          enable-cache: true

      - name: Cache üíΩ pre-commit
        if: ${{ inputs.use-cache == true }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|py${{ inputs.python-version }}|${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit ü§ñ
        id: precommit
        run: |
          uv pip install -q pre-commit
          pre-commit run --all-files

      - name: Minimize uv cache
        run: uv cache prune --ci

      - name: Fixing Pull Request ‚Ü©Ô∏è
        if: always() && inputs.push-fixes == true && steps.precommit.outcome == 'failure'
        uses: actions-js/push@v1.5
        with:
          github_token: ${{ secrets.github-token || github.token }}
          message: "pre-commit: running and fixing..."
          branch: ${{ github.ref_name }}
